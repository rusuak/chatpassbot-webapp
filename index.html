<!doctype html>
<meta charset="utf-8">
<title>Open events</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  function run() {
    const wa = window.Telegram?.WebApp;
    if (!wa) {
      document.getElementById('status').textContent = "Open this page via Telegram WebApp link.";
      return;
    }
    try {
      wa.ready();
      wa.expand();

      const sp = new URLSearchParams(location.search);
      const fromQuery = sp.get("org") || "";

      // При запуске через startapp (NOT для клавиатуры) start_param попадёт сюда:
      const startParam = wa.initDataUnsafe?.start_param || "";

      let org = startParam && startParam.startsWith("org:") ? startParam.slice(4) : startParam;
      if (!org) org = fromQuery; // для клавиатуры пробрасываем ?org=<slug>

      // Отправляем данные боту (только для KeyboardButton это реально доставится)
      wa.sendData(JSON.stringify({ t: "open_org", org }));

      setTimeout(() => wa.close(), 100);
    } catch (e) {
      document.getElementById('status').textContent = "Could not open. Please return to the chat and try again.";
    }
  }
  window.addEventListener('load', run);
</script>
<body style="font-family:system-ui, sans-serif; padding:24px">
  <h1 style="margin:0 0 12px">Opening…</h1>
  <p id="status">If nothing happens, return to the chat..</p>
</body>
